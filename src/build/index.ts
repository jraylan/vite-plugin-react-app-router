/**
 * Build mode handler
 * Generates routes statically for bundle inclusion
 */

import type { PluginHookHandler } from "../commons/types.js";
import type { ResolvedConfig } from "vite";
import { parseAppRouter, generateBuildRoutesCode, generateEmptyRoutesCode, type PluginOptions } from "../commons/index.js";
import * as path from "path";
import * as fs from "fs";

const VIRTUAL_MODULE_ID = "virtual:app-router";
const RESOLVED_VIRTUAL_MODULE_ID = "\0" + VIRTUAL_MODULE_ID + ".js";

interface BuildContext {
    config?: ResolvedConfig;
    options: PluginOptions;
    generatedCode?: string;
}

const ctx: BuildContext = {
    options: {},
};

/**
 * Sets plugin options
 */
export function setOptions(options: PluginOptions): void {
    ctx.options = options;
}

/**
 * Outputs debug information based on debug option
 */
function outputDebug(code: string): void {
    const debug = ctx.options.debug;
    if (!debug) return;

    const separator = '='.repeat(60);
    const header = `\n${separator}\n[vite-plugin-react-app-router] Generated Routes (BUILD)\n${separator}\n`;
    const footer = `\n${separator}\n`;

    if (debug === true || debug === 'console') {
        console.log(header + code + footer);
    } else if (typeof debug === 'string') {
        const outputPath = path.resolve(ctx.config?.root || process.cwd(), debug);
        fs.writeFileSync(outputPath, `// Generated by vite-plugin-react-app-router (BUILD mode)\n// ${new Date().toISOString()}\n\n${code}`);
        console.log(`[vite-plugin-react-app-router] Debug output written to: ${outputPath}`);
    }
}

/**
 * Generates the routes code for build
 */
function generateRoutes(): string {
    if (!ctx.config) {
        return generateEmptyRoutesCode();
    }

    const rootDir = ctx.config.root;
    const appDir = ctx.options.appDir || path.join(rootDir, "src/app");

    if (!fs.existsSync(appDir)) {
        console.warn(`[vite-plugin-react-app-router] App directory not found: ${appDir}`);
        return generateEmptyRoutesCode();
    }

    const { routes, rootNotFound } = parseAppRouter({
        ...ctx.options,
        appDir,
    });

    // In build, we use static imports for better tree-shaking
    ctx.generatedCode = generateBuildRoutesCode(routes, { rootDir, lazy: false, rootNotFound });
    outputDebug(ctx.generatedCode);
    return ctx.generatedCode;
}

const buildHandler: PluginHookHandler = {
    configResolved(config: ResolvedConfig) {
        ctx.config = config;

        // Pre-generate routes during build
        generateRoutes();
    },
};

// Export functions for use in the main plugin
export function resolveId(id: string): string | undefined {
    if (id === VIRTUAL_MODULE_ID) {
        return RESOLVED_VIRTUAL_MODULE_ID;
    }
    return undefined;
}

export function load(id: string): string | undefined {
    if (id === RESOLVED_VIRTUAL_MODULE_ID) {
        return ctx.generatedCode || generateRoutes();
    }
    return undefined;
}

export const VIRTUAL_ID = VIRTUAL_MODULE_ID;
export const RESOLVED_ID = RESOLVED_VIRTUAL_MODULE_ID;

export default buildHandler;